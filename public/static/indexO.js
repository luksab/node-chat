var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(b){var c=0;return function(){return c<b.length?{done:!1,value:b[c++]}:{done:!0}}};$jscomp.arrayIterator=function(b){return{next:$jscomp.arrayIteratorImpl(b)}};$jscomp.makeIterator=function(b){var c="undefined"!=typeof Symbol&&Symbol.iterator&&b[Symbol.iterator];return c?c.call(b):$jscomp.arrayIterator(b)};
$jscomp.checkStringArgs=function(b,c,g){if(null==b)throw new TypeError("The 'this' value for String.prototype."+g+" must not be null or undefined");if(c instanceof RegExp)throw new TypeError("First argument to String.prototype."+g+" must not be a regular expression");return b+""};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,c,g){b!=Array.prototype&&b!=Object.prototype&&(b[c]=g.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,c,g,h){if(c){g=$jscomp.global;b=b.split(".");for(h=0;h<b.length-1;h++){var d=b[h];d in g||(g[d]={});g=g[d]}b=b[b.length-1];h=g[b];c=c(h);c!=h&&null!=c&&$jscomp.defineProperty(g,b,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("String.prototype.repeat",function(b){return b?b:function(b){var c=$jscomp.checkStringArgs(this,null,"repeat");if(0>b||1342177279<b)throw new RangeError("Invalid count value");b|=0;for(var h="";b;)if(b&1&&(h+=c),b>>>=1)c+=c;return h}},"es6","es3");$jscomp.findInternal=function(b,c,g){b instanceof String&&(b=String(b));for(var h=b.length,d=0;d<h;d++){var t=b[d];if(c.call(g,t,d,b))return{i:d,v:t}}return{i:-1,v:void 0}};
$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(b,g){return $jscomp.findInternal(this,b,g).v}},"es6","es3");$jscomp.polyfill("Number.MAX_SAFE_INTEGER",function(){return 9007199254740991},"es6","es3");$jscomp.owns=function(b,c){return Object.prototype.hasOwnProperty.call(b,c)};$jscomp.polyfill("Object.values",function(b){return b?b:function(b){var c=[],h;for(h in b)$jscomp.owns(b,h)&&c.push(b[h]);return c}},"es8","es3");$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(b){function c(){this.batch_=null}function g(b){return b instanceof d?b:new d(function(n,c){n(b)})}if(b&&!$jscomp.FORCE_POLYFILL_PROMISE)return b;c.prototype.asyncExecute=function(b){null==this.batch_&&(this.batch_=[],this.asyncExecuteBatch_());this.batch_.push(b);return this};c.prototype.asyncExecuteBatch_=function(){var b=this;this.asyncExecuteFunction(function(){b.executeBatch_()})};var h=$jscomp.global.setTimeout;c.prototype.asyncExecuteFunction=function(b){h(b,
0)};c.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var b=this.batch_;this.batch_=[];for(var x=0;x<b.length;++x){var c=b[x];b[x]=null;try{c()}catch(p){this.asyncThrow_(p)}}}this.batch_=null};c.prototype.asyncThrow_=function(b){this.asyncExecuteFunction(function(){throw b;})};var d=function(b){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var n=this.createResolveAndReject_();try{b(n.resolve,n.reject)}catch(u){n.reject(u)}};d.prototype.createResolveAndReject_=
function(){function b(b){return function(n){d||(d=!0,b.call(c,n))}}var c=this,d=!1;return{resolve:b(this.resolveTo_),reject:b(this.reject_)}};d.prototype.resolveTo_=function(b){if(b===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(b instanceof d)this.settleSameAsPromise_(b);else{a:switch(typeof b){case "object":var c=null!=b;break a;case "function":c=!0;break a;default:c=!1}c?this.resolveToNonPromiseObj_(b):this.fulfill_(b)}};d.prototype.resolveToNonPromiseObj_=function(b){var c=
void 0;try{c=b.then}catch(u){this.reject_(u);return}"function"==typeof c?this.settleSameAsThenable_(c,b):this.fulfill_(b)};d.prototype.reject_=function(b){this.settle_(2,b)};d.prototype.fulfill_=function(b){this.settle_(1,b)};d.prototype.settle_=function(b,c){if(0!=this.state_)throw Error("Cannot settle("+b+", "+c+"): Promise already settled in state"+this.state_);this.state_=b;this.result_=c;this.executeOnSettledCallbacks_()};d.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var b=
0;b<this.onSettledCallbacks_.length;++b)t.asyncExecute(this.onSettledCallbacks_[b]);this.onSettledCallbacks_=null}};var t=new c;d.prototype.settleSameAsPromise_=function(b){var c=this.createResolveAndReject_();b.callWhenSettled_(c.resolve,c.reject)};d.prototype.settleSameAsThenable_=function(b,c){var d=this.createResolveAndReject_();try{b.call(c,d.resolve,d.reject)}catch(p){d.reject(p)}};d.prototype.then=function(b,c){function g(b,c){return"function"==typeof b?function(c){try{p(b(c))}catch(E){h(E)}}:
c}var p,h,n=new d(function(b,c){p=b;h=c});this.callWhenSettled_(g(b,p),g(c,h));return n};d.prototype.catch=function(b){return this.then(void 0,b)};d.prototype.callWhenSettled_=function(b,c){function d(){switch(g.state_){case 1:b(g.result_);break;case 2:c(g.result_);break;default:throw Error("Unexpected state: "+g.state_);}}var g=this;null==this.onSettledCallbacks_?t.asyncExecute(d):this.onSettledCallbacks_.push(d)};d.resolve=g;d.reject=function(b){return new d(function(c,d){d(b)})};d.race=function(b){return new d(function(c,
d){for(var h=$jscomp.makeIterator(b),n=h.next();!n.done;n=h.next())g(n.value).callWhenSettled_(c,d)})};d.all=function(b){var c=$jscomp.makeIterator(b),h=c.next();return h.done?g([]):new d(function(b,d){function p(c){return function(d){n[c]=d;t--;0==t&&b(n)}}var n=[],t=0;do n.push(void 0),t++,g(h.value).callWhenSettled_(p(n.length-1),d),h=c.next();while(!h.done)})};return d},"es6","es3");
function cycleNavBar(b){window.matchMedia("(min-width: 800px)").matches||("25em"==document.getElementById("mySidenav").style.width?document.getElementById("mySidenav").style.width="0":b||(document.getElementById("mySidenav").style.width="25em"));return!1}window.onresize=function(b){window.matchMedia("(min-width: 800px)").matches&&"0px"==document.getElementById("mySidenav").style.width&&(document.getElementById("mySidenav").style.width="25em")};
window.onload=function(){function b(a){var f="=".repeat((4-a.length%4)%4);a=(a+f).replace(/\-/g,"+").replace(/_/g,"/");a=window.atob(a);f=new Uint8Array(a.length);for(var b=0;b<a.length;++b)f[b]=a.charCodeAt(b);return f}function c(){y.addEventListener("click",function(){y.disabled=!0;A?t():d()});F.pushManager.getSubscription().then(function(a){A=null!==a;h(a);A?console.log("User IS subscribed."):console.log("User is NOT subscribed.");g()})}function g(){"denied"===Notification.permission?(y.textContent=
"Push Messaging Blocked.",y.disabled=!0,h(null)):(y.textContent=A?"Disable Push Messaging":"Enable Push Messaging",y.disabled=!1)}function h(a){m.emit("push",a);console.log(JSON.stringify(a))}function d(){var a=b("BM_12EMi2xCAVhD2tn_gr3DugdW_bYnxtVCJd1qzAZTag5gi-IH97Vetc5sYfr155JiPGceLMVMXy29GmFCES20");F.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:a}).then(function(a){console.log("User is subscribed.");h(a);A=!0;g()}).catch(function(a){console.error("Failed to subscribe the user: ",
a);g()})}function t(){F.pushManager.getSubscription().then(function(a){if(a)return a.unsubscribe()}).catch(function(a){console.error("Error unsubscribing",a)}).then(function(){h(null);console.log("User is unsubscribed.");A=!1;g()})}function n(a){if("Yes"===a.path[0].innerHTML&&"lines"===v.rootEl.parentElement.getAttribute("id")&&0!==v.rootEl.getAttribute("dbid")){a=G.transaction(["messages"],"readwrite").objectStore("messages");a.index("chat");console.log(v.rootEl.getAttribute("dbid"));var b=parseInt(v.rootEl.getAttribute("dbid"));
0<b?(a=a.delete(b),a.onsuccess=function(a){console.log("deleted successfully")},a.onerror=function(a){console.log("couldn't delete: "+a)},v.rootEl.parentElement.removeChild(v.rootEl)):z("System","Couldn't delete message. Reloading might help.")}}function x(a){try{var b=G.transaction(["messages"],"readwrite").objectStore("messages").index("chat").openCursor();b.onsuccess=function(b){if(b=b.target.result){if(a===b.value.chat&&(k.innerHTML="undefined"!==typeof b.value.encrypted&&b.value.encrypted?k.innerHTML+
('<p class="encrypted" dbID="'+b.value.id+'"><b>'+b.value.sender+"</b>"+b.value.message+"</p>"):k.innerHTML+('<p dbID="'+b.value.id+'" ><b>'+b.value.sender+"</b>"+b.value.message+"</p>"),0===b.value.message.indexOf("<img"))){var f=k.children[k.children.length-1].children[1];f.removeAttribute("height");f.removeAttribute("width");var e=(k.clientWidth|0)-20,c=(k.clientHeight|0)-20;e<c?f.width=e:f.height=c}b.continue()}setTimeout(function(){return k.scrollTop=Number.MAX_SAFE_INTEGER},10)};b.onerror=function(a){return console.log(a)};
return!0}catch(e){return console.log(e),!1}}function u(a,b,e,c,d){c=void 0===c?!1:c;d=void 0===d?!1:d;try{var f=G.transaction(["messages"],"readwrite").objectStore("messages").add({chat:a,sender:b,message:e,encrypted:c});f.onsuccess=function(a){d&&d.setAttribute("dbid",a.srcElement.result);console.log(a.srcElement.result)};f.onerror=function(a){console.error(a)}}catch(Y){console.error(Y)}}function p(a,b,e){e=void 0===e?!1:e;r.hasOwnProperty(l)||(r[l]=[]);r[l].push({from:a,msg:b,encrypted:e});k.innerHTML=
e?k.innerHTML+('<p class="encrypted"><b>'+a+"</b>"+b+"</p>"):k.innerHTML+("<p><b>"+a+"</b>"+b+"</p>");u(l,a,b,e,k.children[k.children.length-1]);0===b.indexOf("<img")&&(a=k.children[k.children.length-1].children[1],a.removeAttribute("height"),a.removeAttribute("width"),b=(k.clientWidth|0)-20,e=(k.clientHeight|0)-20,b<e?a.width=b:a.height=e);setTimeout(function(){return k.scrollTop=Number.MAX_SAFE_INTEGER},10)}function W(a,b){Q.push({from:a,msg:b});"allChat"==l&&(k.innerHTML+="<p><b>"+a+"</b>"+b+"</p>",
setTimeout(function(){return k.scrollTop=Number.MAX_SAFE_INTEGER},10))}function z(a,b){k.innerHTML+="<p><b>"+a+"</b>"+b+"</p>";setTimeout(function(){return k.scrollTop=Number.MAX_SAFE_INTEGER},10)}function N(a,b){a=(k.clientWidth|0)-20;var f=(k.clientHeight|0)-20;a<f?p("me",'<img background-image src="'+b+'" width="'+a+'"/>',!1):p("me",'<img background-image src="'+b+'" height="'+f+'"/>',!1)}function X(a,b){a.slice?a=a.slice(0,131072):a.webkitSlice&&(a=a.webkitSlice(0,131072));var f=new FileReader;
f.onload=function(a){a=new DataView(a.target.result);if(65496!=a.getUint16(0,!1))b(-2);else{for(var f=a.byteLength,e=2;e<f;){var c=a.getUint16(e,!1);e+=2;if(65505==c){if(1165519206!=a.getUint32(e+=2,!1)){b(-1);return}c=18761==a.getUint16(e+=6,!1);e+=a.getUint32(e+4,c);var d=a.getUint16(e,c);e+=2;for(var q=0;q<d;q++)if(274==a.getUint16(e+12*q,c)){b(a.getUint16(e+12*q+8,c));return}}else if(65280!=(c&65280))break;else e+=a.getUint16(e,!1)}b(-1)}};f.readAsArrayBuffer(a)}function P(a,b,e,c,d,h){var f=
new Image;f.onerror=function(){URL.revokeObjectURL(this.src);h(a)};f.onload=function(){URL.revokeObjectURL(this.src);X(a,function(a){var b=f.width,d=f.height,q=4<a?Math.min(c/b,e/d,1):Math.min(e/b,c/d,1);d=Math.round(d*q);b=Math.round(b*q);q=d;d=document.createElement("canvas");4<a?(d.width=q,d.height=b):(d.width=b,d.height=q);1<a&&console.log("EXIF orientation = "+a+", rotating picture");var g=d.getContext("2d");switch(a){case 2:g.transform(-1,0,0,1,b,0);break;case 3:g.transform(-1,0,0,-1,b,q);break;
case 4:g.transform(1,0,0,-1,0,q);break;case 5:g.transform(0,1,1,0,0,0);break;case 6:g.transform(0,1,-1,0,q,0);break;case 7:g.transform(0,-1,-1,0,q,b);break;case 8:g.transform(0,-1,1,0,0,b)}g.drawImage(f,0,0,b,q);a=d.toDataURL("image/jpeg",.7);h(a,d)})};f.src=URL.createObjectURL(a)}function E(a,b){return new Promise(function(f){crypto.subtle.generateKey(a,!0,b).then(function(a){f(a)}).catch(function(a){return console.log(a.message)})})}function Z(a){a=unescape(encodeURIComponent(a));for(var b=new Uint8Array(a.length),
e=0;e<a.length;e++)b[e]=a.charCodeAt(e);return b}function aa(a){a=new Uint8Array(a);for(var b="",e=0;e<a.byteLength;e++)b+=String.fromCharCode(a[e]);return b}function R(a,b){a=new Uint8Array(a);for(var f="",c=0;c<a.byteLength;c++)f+=String.fromCharCode(a[c]);a=btoa(f);f="-----BEGIN "+b+"-----\r\n";for(c=0;c<a.length;)f=c+64<=a.length?f+(a.substr(c,64)+"\r\n"):f+(a.substr(c)+"\r\n"),c+=64;return f+("-----END "+b+"-----\r\n")}function H(a){a=a.split("\n");for(var b="",e=0;e<a.length;e++)0<a[e].trim().length&&
0>a[e].indexOf("-BEGIN RSA PRIVATE KEY-")&&0>a[e].indexOf("-BEGIN RSA PUBLIC KEY-")&&0>a[e].indexOf("-END RSA PRIVATE KEY-")&&0>a[e].indexOf("-END RSA PUBLIC KEY-")&&(b+=a[e].trim());a=atob(b);b=new Uint8Array(a.length);for(e=0;e<a.length;e++)b[e]=a.charCodeAt(e);return b.buffer}function S(a){return new Promise(function(b){crypto.subtle.importKey("spki",H(a),I,!0,["encrypt"]).then(function(a){b(a)}).catch(function(a){return console.log(a.message)})})}function T(a){return new Promise(function(b){crypto.subtle.importKey("spki",
H(a),J,!0,["verify"]).then(function(a){b(a)})})}function ba(a){return new Promise(function(b){crypto.subtle.importKey("pkcs8",H(a),J,!0,["sign"]).then(function(a){b(a)})})}function ca(a){return new Promise(function(b){crypto.subtle.importKey("pkcs8",H(a),I,!0,["decrypt"]).then(function(a){b(a)})})}function U(a){return new Promise(function(b){window.crypto.subtle.exportKey("spki",a.publicKey).then(function(a){b(R(a,"RSA PUBLIC KEY"))})})}function V(a){return new Promise(function(b){window.crypto.subtle.exportKey("pkcs8",
a.privateKey).then(function(a){b(R(a,"RSA PRIVATE KEY"))})})}function da(a,b){return crypto.subtle.encrypt({name:"RSA-OAEP"},a,Z(b))}(function(a){a.event.fix=function(a){return function(b){b=a.apply(this,arguments);if(0===b.type.indexOf("copy")||0===b.type.indexOf("paste"))b.clipboardData=b.originalEvent.clipboardData;return b}}(a.event.fix);var b={callback:a.noop,matchType:/image.*/};return a.fn.pasteImageReader=function(f){"function"===typeof f&&(f={callback:f});f=a.extend({},b,f);return this.each(function(){var b=
this;return a(this).bind("paste",function(a){var c=!1;var e=a.clipboardData;return Array.prototype.forEach.call(e.types,function(a,d){if(!c&&(a.match(f.matchType)||e.items[d].type.match(f.matchType))){var g=e.items[d].getAsFile();a=new FileReader;a.onload=function(a){return f.callback.call(b,{dataURL:a.target.result,event:a,file:g,name:g.name})};a.readAsDataURL(g);return c=!0}})})})}})(jQuery);window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;window.IDBTransaction=
window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction;window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;var K=window.indexedDB.open("messages",1);K.onerror=function(a){console.error(a)};var G;K.onsuccess=function(a){console.log("Database initialised");G=K.result;"allChat"!=l&&x(l)};K.onupgradeneeded=function(a){a=a.target.result;a.onerror=function(a){console.error("Error loading database.")};objectStore=a.createObjectStore("messages",{keyPath:"id",
autoIncrement:!0});objectStore.createIndex("chat","chat",{unique:!1});objectStore.createIndex("sender","sender",{unique:!1});objectStore.createIndex("message","message",{unique:!1});console.log("Object store created.")};var k=document.getElementById("lines"),D=document.getElementById("contactsSearch"),l=location.search.substring(1)?location.search.substring(1):"allChat",r={};"allChat"!=l&&(document.getElementsByTagName("span")[0].innerText="\u2630 "+("allChat"===l?"Cool Chat":l));var Q=[],w=[],A=
!1,F=null,y=document.querySelector(".settbtn");"serviceWorker"in navigator&&"PushManager"in window?navigator.serviceWorker.register("/static/service-worker.js").then(function(a){console.log("Service Worker is registered",a);F=a;c()}).catch(function(a){console.error("Service Worker Error",a)}):(console.warn("Push messaging is not supported"),y.textContent="Push Not Supported");document.getElementById("Logout").addEventListener("click",function(){try{t()}catch(a){}localStorage.clear();location.reload();
return!1});var v;$(document).bind("click",function(a){document.getElementById("rmenu").className="hide"});document.addEventListener?document.addEventListener("contextmenu",function(a){var b=a.path.find(function(a){return"P"===a.tagName});console.log(b||"Didn't click on a message!");if(b&&"lines"===b.parentElement.getAttribute("id")&&0!==b.getAttribute("dbid")){a.preventDefault();document.getElementById("rmenu").innerHTML='<ul><li>Do you really want to delete the message?</li><li id="messageToDelete"> </li><li> <div><a class="danger" style="cursor: pointer;">Yes</a></div><div><a style="cursor: pointer;">No</a></div></li></ul>';
document.getElementById("rmenu").className="show";var c=document.getElementById("rmenu").style;var d=event.pageY?event.pageY:event.clientY?event.clientY+(document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop):null;c.top=d+"px";c=document.getElementById("rmenu").style;d=event.pageX?event.pageX:event.clientX?event.clientX+(document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft):null;c.left=d+"px";document.getElementById("rmenu").onclick=
n;b.children[1]&&"IMG"===b.children[1].tagName?document.getElementById("messageToDelete").innerHTML="<b>"+b.children[0].innerHTML+"</b>: Image":document.getElementById("messageToDelete").innerHTML=b.innerHTML;v=a;v.rootEl=b}},!1):document.attachEvent("oncontextmenu",function(){window.event.returnValue=!1});var m=io.connect();m.on("connect",function(){$("#chat").addClass("connected");null!==localStorage.getItem("name")&&null!==localStorage.getItem("passwd")&&m.emit("nickname",{nick:localStorage.getItem("name"),
passwd:localStorage.getItem("passwd")},function(a){if(!a)return z("System","Reconnected to the server with localStorage"),document.getElementById("message").disabled=!1,document.getElementById("imagefile").disabled=!1,$("#chat").addClass("nickname-set")})});m.on("announcement",function(a){$("#lines").append($("<p>").append($("<em>").text(a)))});m.on("reload",function(){return location.reload()});m.on("nicknames",function(a){w=a;$("#nicknames").empty().append($("<span>Online: </span>"));$("#nicknames").append($("<b>").text("allChat"));
for(var b in w)$("#nicknames").append($(w[b]===localStorage.getItem("name")?'<b style="background: coral">':"<b>").text(w[b]))});document.getElementById("nicknames").addEventListener("click",function(a){a=a.target;if("B"==a.tagName&&a.innerText!==localStorage.getItem("name")){cycleNavBar();l=a.innerText;"allChat"!==l&&m.emit("getKey",l);document.getElementsByTagName("span")[1].innerText="\u2630 "+("allChat"===l?"Cool Chat":l);k.innerHTML="";if("allChat"===l){var b=$jscomp.makeIterator(Q);for(a=b.next();!a.done;a=
b.next())el=a.value,k.innerHTML+="<p><b>"+el.from+"</b>"+el.msg+"</p>"}else if(!x(l)&&null!=r[l])for(b=$jscomp.makeIterator(r[l]),a=b.next();!a.done;a=b.next())a=a.value,k.innerHTML+="<p><b>"+a.from+"</b>"+a.msg+"</p>";setTimeout(function(){return k.scrollTop=Number.MAX_SAFE_INTEGER},10)}});m.on("user message",function(a,b){return W(a,b)});m.on("user image",N);m.on("dm",function(a){a.from==l?p(a.from,a.msg):(u(a.from,a.from,a.msg),r.hasOwnProperty(a.from)||(r[a.from]=[]),r[a.from].push({from:a.from,
msg:a.msg}))});m.on("reconnect",function(){m.emit("nickname",{nick:localStorage.getItem("name"),passwd:localStorage.getItem("passwd")},function(a){if(!a)return $("#message").val("").focus(),document.getElementById("message").disabled=!1,document.getElementById("imagefile").disabled=!1,$("#chat").addClass("nickname-set");t();location.reload()});z("System","Reconnected to the server")});m.on("dmImage",function(a){var b=(k.clientWidth|0)-20,c=(k.clientHeight|0)-20;a.from==l?b<c?p(a.from,'<img background-image src="'+
a.msg+'" width="'+b+'"/>'):p(a.from,'<img background-image src="'+a.msg+'" height="'+c+'"/>'):(u(a.from,a.from,'<img background-image src="'+a.msg+'" width="'+b+'"/>'),r.hasOwnProperty(a.from)||(r[a.from]=[]),r[a.from].push({from:a.from,msg:'<img background-image src="'+a.msg+'" width="'+b+'"/>'}))});m.on("disconnect",function(){return z("System","Disconnected")});m.on("error",function(a){z("System",a?a:"A unknown error occurred")});D.onchange=D.onkeyup=D.onclick=function(){if(""!=D.value){nicks=
fuzzysort.go(D.value,Object.values(w),{threshold:-999});$("#nicknames").empty().append($("<span>Online: </span>"));$("#nicknames").append($("<b>").text("allChat"));for(var a in nicks)$("#nicknames").append($(nicks[a].target===localStorage.getItem("name")?'<b style="background: coral">':"<b>").text(nicks[a].target)),$("#nicknames").append($("<b>").text())}else for(a in $("#nicknames").empty().append($("<span>Online: </span>")),$("#nicknames").append($("<b>").text("allChat")),w)$("#nicknames").append($(w[a]===
localStorage.getItem("name")?'<b style="background: coral">':"<b>").text(w[a]))};$(function(){document.getElementById("register").onclick=function(){localStorage.setItem("name",$("#nick").val());localStorage.setItem("passwd",$("#passwd").val());m.emit("nickname",{nick:$("#nick").val(),passwd:$("#passwd").val()},function(a){if(!a)return $("#message").val("").focus(),document.getElementById("message").disabled=!1,document.getElementById("imagefile").disabled=!1,$("#chat").addClass("nickname-set");$("#nickname-err").css("visibility",
"visible")});return!1};$("#send-message").submit(function(a){a.preventDefault();if(l)return B[l]?da(B[l].encrypt,$("#message").val()).then(function(a){window.crypto.subtle.sign(J,L,a).then(function(b){p("me",$("#message").val(),!0);console.log("sending Encrypted MSG");m.emit("encryptedDM",{user:l,msg:a,signature:b});$("#message").val("").focus();$("#lines").get(0).scrollTop=Number.MAX_SAFE_INTEGER})}):(p("me",$("#message").val()),m.emit("dm",{user:l,msg:$("#message").val()}),$("#message").val("").focus(),
$("#lines").get(0).scrollTop=Number.MAX_SAFE_INTEGER),!1;alert("No dm");z("me",$("#message").val());m.emit("user message",$("#message").val());$("#message").val("").focus();$("#lines").get(0).scrollTop=Number.MAX_SAFE_INTEGER;return!1});$("#imagefile").bind("change",function(a){P(this.files[0],512E3,600,Infinity,.7,function(a){N("me",a);m.emit("dmImage",{user:l,msg:a})})});$("#message").pasteImageReader(function(a){a=function(a,b,c){b=void 0===b?"":b;c=void 0===c?512:c;a=atob(a);for(var d=[],f=0;f<
a.length;f+=c){for(var e=a.slice(f,f+c),g=Array(e.length),h=0;h<e.length;h++)g[h]=e.charCodeAt(h);e=new Uint8Array(g);d.push(e)}return new Blob(d,{type:b})}(a.dataURL.slice(22),a.dataURL.slice(5,a.dataURL.indexOf(";")));P(a,512E3,600,Infinity,.7,function(a,b){N("me",a);m.emit("dmImage",{user:l,msg:a})})})});HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(a,b,c){c=atob(this.toDataURL(b,c).split(",")[1]);for(var d=c.length,f=new Uint8Array(d),
e=0;e<d;e++)f[e]=c.charCodeAt(e);a(new Blob([f],{type:b||"image/png"}))}});window.URL=window.URL||window.webkitURL;var J={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"},modulusLength:2048,extractable:!1,publicExponent:new Uint8Array([1,0,1])},I={name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),extractable:!1,hash:{name:"SHA-256"}},C=["encrypt","decrypt"],M=!1,L=!1;null!=localStorage.getItem("signKeyS")&&null!=localStorage.getItem("encryptKeyS")&&ba(localStorage.getItem("signKeyS")).then(function(a){ca(localStorage.getItem("encryptKeyS")).then(function(b){L=
a;M=b;console.log("successfully imported Private Keys")})});if(null==localStorage.getItem("encryptKeyP")||null==localStorage.getItem("encryptKeyS"))E(I,C).then(function(a){M=a.privateKey;U(a).then(function(a){localStorage.setItem("encryptKeyP",a);console.log("PushEncryptKey"+a);m.emit("PushEncryptKey",a)});V(a).then(function(a){localStorage.setItem("encryptKeyS",a)})}).catch(function(a){return console.log(a.message)});else{var O=localStorage.getItem("encryptKeyP");S(O).then(function(a){M=a});console.log("PushEncryptKey"+
O);m.emit("PushEncryptKey",O)}null==localStorage.getItem("signKeyP")||null==localStorage.getItem("signKeyS")?E(I,C).then(function(a){L=a.privateKey;U(a).then(function(a){localStorage.setItem("signKeyP",a);console.log("PushEncryptKey"+a);m.emit("PushEncryptKey",a)});V(a).then(function(a){localStorage.setItem("signKeyS",a)})}).catch(function(a){return console.log(a.message)}):(C=localStorage.getItem("signKeyP"),T(C).then(function(a){L=a}),console.log("PushSignKey"+C),m.emit("PushSignKey",C));var B=
{};m.on("establishEncryption",function(a,b){console.log("received Key from "+a+":");console.log(b);T(b.sign).then(function(c){S(b.encrypt).then(function(b){B[a]={encrypt:b,sign:c};console.log(c);console.log(b)})})});m.on("encryptedDM",function(a){B[a.from]&&crypto.subtle.decrypt({name:"RSA-OAEP"},M,a.msg).then(function(b){b=aa(b);crypto.subtle.verify(J,B[a.from].sign,a.signature,a.msg).then(function(c){if(!c)return console.log("public Key:"),console.log(B[a.from].sign),console.log("signature:"),console.log(a.signature),
console.log("message"),console.log(a.msg),console.log("decrypted msg"),console.log(b),alert(a.from+" send an invalid message!!!");a.from==l?p(a.from,b,!0):(u(a.from,a.from,b,!0),r.hasOwnProperty(a.from)||(r[a.from]=[]),r[a.from].push({from:a.from,msg:b}));console.log("Signature verified after importing PEM public key:",c)})})})};