var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(b){var d=0;return function(){return d<b.length?{done:!1,value:b[d++]}:{done:!0}}};$jscomp.arrayIterator=function(b){return{next:$jscomp.arrayIteratorImpl(b)}};$jscomp.makeIterator=function(b){var d="undefined"!=typeof Symbol&&Symbol.iterator&&b[Symbol.iterator];return d?d.call(b):$jscomp.arrayIterator(b)};
$jscomp.checkStringArgs=function(b,d,p){if(null==b)throw new TypeError("The 'this' value for String.prototype."+p+" must not be null or undefined");if(d instanceof RegExp)throw new TypeError("First argument to String.prototype."+p+" must not be a regular expression");return b+""};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,d,p){b!=Array.prototype&&b!=Object.prototype&&(b[d]=p.value)};$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(b,d,p,l){if(d){p=$jscomp.global;b=b.split(".");for(l=0;l<b.length-1;l++){var g=b[l];g in p||(p[g]={});p=p[g]}b=b[b.length-1];l=p[b];d=d(l);d!=l&&null!=d&&$jscomp.defineProperty(p,b,{configurable:!0,writable:!0,value:d})}};
$jscomp.polyfill("String.prototype.repeat",function(b){return b?b:function(b){var d=$jscomp.checkStringArgs(this,null,"repeat");if(0>b||1342177279<b)throw new RangeError("Invalid count value");b|=0;for(var l="";b;)if(b&1&&(l+=d),b>>>=1)d+=d;return l}},"es6","es3");$jscomp.owns=function(b,d){return Object.prototype.hasOwnProperty.call(b,d)};$jscomp.polyfill("Object.values",function(b){return b?b:function(b){var d=[],l;for(l in b)$jscomp.owns(b,l)&&d.push(b[l]);return d}},"es8","es3");
$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(b){function d(){this.batch_=null}function p(c){return c instanceof g?c:new g(function(b,d){b(c)})}if(b&&!$jscomp.FORCE_POLYFILL_PROMISE)return b;d.prototype.asyncExecute=function(c){null==this.batch_&&(this.batch_=[],this.asyncExecuteBatch_());this.batch_.push(c);return this};d.prototype.asyncExecuteBatch_=function(){var c=this;this.asyncExecuteFunction(function(){c.executeBatch_()})};var l=$jscomp.global.setTimeout;d.prototype.asyncExecuteFunction=function(c){l(c,
0)};d.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var c=this.batch_;this.batch_=[];for(var b=0;b<c.length;++b){var d=c[b];c[b]=null;try{d()}catch(q){this.asyncThrow_(q)}}}this.batch_=null};d.prototype.asyncThrow_=function(b){this.asyncExecuteFunction(function(){throw b;})};var g=function(b){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var c=this.createResolveAndReject_();try{b(c.resolve,c.reject)}catch(t){c.reject(t)}};g.prototype.createResolveAndReject_=
function(){function b(b){return function(c){g||(g=!0,b.call(d,c))}}var d=this,g=!1;return{resolve:b(this.resolveTo_),reject:b(this.reject_)}};g.prototype.resolveTo_=function(b){if(b===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(b instanceof g)this.settleSameAsPromise_(b);else{a:switch(typeof b){case "object":var c=null!=b;break a;case "function":c=!0;break a;default:c=!1}c?this.resolveToNonPromiseObj_(b):this.fulfill_(b)}};g.prototype.resolveToNonPromiseObj_=function(b){var c=
void 0;try{c=b.then}catch(t){this.reject_(t);return}"function"==typeof c?this.settleSameAsThenable_(c,b):this.fulfill_(b)};g.prototype.reject_=function(b){this.settle_(2,b)};g.prototype.fulfill_=function(b){this.settle_(1,b)};g.prototype.settle_=function(b,d){if(0!=this.state_)throw Error("Cannot settle("+b+", "+d+"): Promise already settled in state"+this.state_);this.state_=b;this.result_=d;this.executeOnSettledCallbacks_()};g.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var b=
0;b<this.onSettledCallbacks_.length;++b)y.asyncExecute(this.onSettledCallbacks_[b]);this.onSettledCallbacks_=null}};var y=new d;g.prototype.settleSameAsPromise_=function(b){var c=this.createResolveAndReject_();b.callWhenSettled_(c.resolve,c.reject)};g.prototype.settleSameAsThenable_=function(b,d){var c=this.createResolveAndReject_();try{b.call(d,c.resolve,c.reject)}catch(q){c.reject(q)}};g.prototype.then=function(b,d){function c(b,c){return"function"==typeof b?function(c){try{q(b(c))}catch(L){p(L)}}:
c}var q,p,l=new g(function(b,c){q=b;p=c});this.callWhenSettled_(c(b,q),c(d,p));return l};g.prototype.catch=function(b){return this.then(void 0,b)};g.prototype.callWhenSettled_=function(b,d){function c(){switch(g.state_){case 1:b(g.result_);break;case 2:d(g.result_);break;default:throw Error("Unexpected state: "+g.state_);}}var g=this;null==this.onSettledCallbacks_?y.asyncExecute(c):this.onSettledCallbacks_.push(c)};g.resolve=p;g.reject=function(b){return new g(function(c,d){d(b)})};g.race=function(b){return new g(function(c,
d){for(var g=$jscomp.makeIterator(b),l=g.next();!l.done;l=g.next())p(l.value).callWhenSettled_(c,d)})};g.all=function(b){var d=$jscomp.makeIterator(b),c=d.next();return c.done?p([]):new g(function(b,g){function l(c){return function(d){q[c]=d;t--;0==t&&b(q)}}var q=[],t=0;do q.push(void 0),t++,p(c.value).callWhenSettled_(l(q.length-1),g),c=d.next();while(!c.done)})};return g},"es6","es3");
function cycleNavBar(b){window.matchMedia("(min-width: 800px)").matches||("25em"==document.getElementById("mySidenav").style.width?document.getElementById("mySidenav").style.width="0":b||(document.getElementById("mySidenav").style.width="25em"));return!1}window.onresize=function(b){window.matchMedia("(min-width: 800px)").matches&&"0px"==document.getElementById("mySidenav").style.width&&(document.getElementById("mySidenav").style.width="25em")};
window.onload=function(){function b(a){var e="=".repeat((4-a.length%4)%4);a=(a+e).replace(/\-/g,"+").replace(/_/g,"/");a=window.atob(a);e=new Uint8Array(a.length);for(var f=0;f<a.length;++f)e[f]=a.charCodeAt(f);return e}function d(){w.addEventListener("click",function(){w.disabled=!0;z?y():g()});D.pushManager.getSubscription().then(function(a){z=null!==a;l(a);z?console.log("User IS subscribed."):console.log("User is NOT subscribed.");p()})}function p(){"denied"===Notification.permission?(w.textContent=
"Push Messaging Blocked.",w.disabled=!0,l(null)):(w.textContent=z?"Disable Push Messaging":"Enable Push Messaging",w.disabled=!1)}function l(a){m.emit("push",a);console.log(JSON.stringify(a))}function g(){var a=b("BM_12EMi2xCAVhD2tn_gr3DugdW_bYnxtVCJd1qzAZTag5gi-IH97Vetc5sYfr155JiPGceLMVMXy29GmFCES20");D.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:a}).then(function(a){console.log("User is subscribed.");l(a);z=!0;p()}).catch(function(a){console.error("Failed to subscribe the user: ",
a);p()})}function y(){D.pushManager.getSubscription().then(function(a){if(a)return a.unsubscribe()}).catch(function(a){console.error("Error unsubscribing",a)}).then(function(){l(null);console.log("User is unsubscribed.");z=!1;p()})}function c(a){if("Yes"===a.target.innerHTML&&"lines"===u.rootEl.parentElement.getAttribute("id")&&0!==u.rootEl.getAttribute("dbid")){a=E.transaction(["messages"],"readwrite").objectStore("messages");a.index("chat");console.log(u.rootEl.getAttribute("dbid"));var e=parseInt(u.rootEl.getAttribute("dbid"));
0<e?(a=a.delete(e),a.onsuccess=function(a){console.log("deleted successfully")},a.onerror=function(a){console.log("couldn't delete: "+a)},u.rootEl.parentElement.removeChild(u.rootEl)):x("System","Couldn't delete message. Reloading might help.")}}function O(a){try{var e=E.transaction(["messages"],"readwrite").objectStore("messages").index("chat").openCursor();e.onsuccess=function(e){if(e=e.target.result){if(a===e.value.chat&&(h.innerHTML="undefined"!==typeof e.value.encrypted&&e.value.encrypted?h.innerHTML+
('<p class="encrypted" dbID="'+e.value.id+'"><b>'+e.value.sender+"</b>"+e.value.message+"</p>"):h.innerHTML+('<p dbID="'+e.value.id+'" ><b>'+e.value.sender+"</b>"+e.value.message+"</p>"),0===e.value.message.indexOf("<img"))){var b=h.children[h.children.length-1].children[1];b.removeAttribute("height");b.removeAttribute("width");var f=(h.clientWidth|0)-20,c=(h.clientHeight|0)-20;f<c?b.width=f:b.height=c;b.onload=function(){return h.scrollTop=h.scrollHeight}}e.continue()}setTimeout(function(){return h.scrollTop=
h.scrollHeight},10)};e.onerror=function(a){return console.log(a)};return!0}catch(f){return console.log(f),!1}}function t(a,e,b,k,c){k=void 0===k?!1:k;c=void 0===c?!1:c;try{var f=E.transaction(["messages"],"readwrite").objectStore("messages").add({chat:a,sender:e,message:b,encrypted:k});f.onsuccess=function(a){c&&c.setAttribute("dbid",a.srcElement.result);console.log(a.srcElement.result)};f.onerror=function(a){console.error(a)}}catch(X){console.error(X)}}function q(a,e,b,k){b=void 0===b?!1:b;k=void 0===
k?!1:k;console.log(k);k=k?a:k;console.log(k);k&&k!==n?(r.hasOwnProperty(k)||(r[k]=[]),r[k].push({from:a,msg:e,encrypted:b}),t(k,a,e,b,h.children[h.children.length-1])):(r.hasOwnProperty(n)||(r[n]=[]),r[n].push({from:a,msg:e,encrypted:b}),h.innerHTML=b?h.innerHTML+('<p class="encrypted"><b>'+a+"</b>"+e+"</p>"):h.innerHTML+("<p><b>"+a+"</b>"+e+"</p>"),t(n,a,e,b,h.children[h.children.length-1]),0===e.indexOf("<img")&&(a=h.children[h.children.length-1].children[1],a.removeAttribute("height"),a.removeAttribute("width"),
e=(h.clientWidth|0)-20,b=(h.clientHeight|0)-20,e<b?a.width=e:a.height=b,a.onload=function(){return h.scrollTop=h.scrollHeight}),setTimeout(function(){return h.scrollTop=h.scrollHeight},10))}function x(a,e){h.innerHTML+="<p><b>"+a+"</b>"+e+"</p>";setTimeout(function(){return h.scrollTop=h.scrollHeight},10)}function M(a,e){var b=(h.clientWidth|0)-20,k=(h.clientHeight|0)-20;b<k?q(a,'<img background-image src="'+e+'" width="'+b+'"/>',!1):q(a,'<img background-image src="'+e+'" height="'+k+'"/>',!1)}function W(a,
e){a.slice?a=a.slice(0,131072):a.webkitSlice&&(a=a.webkitSlice(0,131072));var b=new FileReader;b.onload=function(a){a=new DataView(a.target.result);if(65496!=a.getUint16(0,!1))e(-2);else{for(var b=a.byteLength,f=2;f<b;){var c=a.getUint16(f,!1);f+=2;if(65505==c){if(1165519206!=a.getUint32(f+=2,!1)){e(-1);return}c=18761==a.getUint16(f+=6,!1);f+=a.getUint32(f+4,c);var k=a.getUint16(f,c);f+=2;for(var d=0;d<k;d++)if(274==a.getUint16(f+12*d,c)){e(a.getUint16(f+12*d+8,c));return}}else if(65280!=(c&65280))break;
else f+=a.getUint16(f,!1)}e(-1)}};b.readAsArrayBuffer(a)}function P(a,e,b,c,d){var f=new Image;f.onerror=function(){URL.revokeObjectURL(this.src);d(a)};f.onload=function(){URL.revokeObjectURL(this.src);W(a,function(a){var c=f.width,k=f.height,g=4<a?Math.min(b/c,e/k,1):Math.min(e/c,b/k,1);k=Math.round(k*g);c=Math.round(c*g);g=k;k=document.createElement("canvas");4<a?(k.width=g,k.height=c):(k.width=c,k.height=g);1<a&&console.log("EXIF orientation = "+a+", rotating picture");var h=k.getContext("2d");
switch(a){case 2:h.transform(-1,0,0,1,c,0);break;case 3:h.transform(-1,0,0,-1,c,g);break;case 4:h.transform(1,0,0,-1,0,g);break;case 5:h.transform(0,1,1,0,0,0);break;case 6:h.transform(0,1,-1,0,g,0);break;case 7:h.transform(0,-1,-1,0,g,c);break;case 8:h.transform(0,-1,1,0,0,c)}h.drawImage(f,0,0,c,g);a=k.toDataURL("image/jpeg",.7);d(a,k)})};f.src=URL.createObjectURL(a)}function Q(a,e){return new Promise(function(b){crypto.subtle.generateKey(a,!0,e).then(function(a){b(a)}).catch(function(a){return console.log(a.message)})})}
function L(a){a=unescape(encodeURIComponent(a));for(var e=new Uint8Array(a.length),b=0;b<a.length;b++)e[b]=a.charCodeAt(b);return e}function Y(a){a=new Uint8Array(a);for(var b="",f=0;f<a.byteLength;f++)b+=String.fromCharCode(a[f]);return b}function R(a,b){a=new Uint8Array(a);for(var e="",c=0;c<a.byteLength;c++)e+=String.fromCharCode(a[c]);a=btoa(e);e="-----BEGIN "+b+"-----\r\n";for(c=0;c<a.length;)e=c+64<=a.length?e+(a.substr(c,64)+"\r\n"):e+(a.substr(c)+"\r\n"),c+=64;return e+("-----END "+b+"-----\r\n")}
function F(a){a=a.split("\n");for(var b="",f=0;f<a.length;f++)0<a[f].trim().length&&0>a[f].indexOf("-BEGIN RSA PRIVATE KEY-")&&0>a[f].indexOf("-BEGIN RSA PUBLIC KEY-")&&0>a[f].indexOf("-END RSA PRIVATE KEY-")&&0>a[f].indexOf("-END RSA PUBLIC KEY-")&&(b+=a[f].trim());a=atob(b);b=new Uint8Array(a.length);for(f=0;f<a.length;f++)b[f]=a.charCodeAt(f);return b.buffer}function S(a){return new Promise(function(b){crypto.subtle.importKey("spki",F(a),G,!0,["encrypt"]).then(function(a){b(a)}).catch(function(a){return console.log(a.message)})})}
function T(a){return new Promise(function(b){crypto.subtle.importKey("spki",F(a),H,!0,["verify"]).then(function(a){b(a)})})}function Z(a){return new Promise(function(b){crypto.subtle.importKey("pkcs8",F(a),H,!0,["sign"]).then(function(a){b(a)})})}function aa(a){return new Promise(function(b){crypto.subtle.importKey("pkcs8",F(a),G,!0,["decrypt"]).then(function(a){b(a)})})}function U(a){return new Promise(function(b){window.crypto.subtle.exportKey("spki",a.publicKey).then(function(a){b(R(a,"RSA PUBLIC KEY"))})})}
function V(a){return new Promise(function(b){window.crypto.subtle.exportKey("pkcs8",a.privateKey).then(function(a){b(R(a,"RSA PRIVATE KEY"))})})}function ba(a,b){return crypto.subtle.encrypt({name:"RSA-OAEP"},a,L(b))}(function(a){a.event.fix=function(a){return function(b){b=a.apply(this,arguments);if(0===b.type.indexOf("copy")||0===b.type.indexOf("paste"))b.clipboardData=b.originalEvent.clipboardData;return b}}(a.event.fix);var b={callback:a.noop,matchType:/image.*/};return a.fn.pasteImageReader=
function(e){"function"===typeof e&&(e={callback:e});e=a.extend({},b,e);return this.each(function(){var b=this;return a(this).bind("paste",function(a){var c=!1;var f=a.clipboardData;return Array.prototype.forEach.call(f.types,function(a,d){if(!c&&(a.match(e.matchType)||f.items[d].type.match(e.matchType))){var g=f.items[d].getAsFile();a=new FileReader;a.onload=function(a){return e.callback.call(b,{dataURL:a.target.result,event:a,file:g,name:g.name})};a.readAsDataURL(g);return c=!0}})})})}})(jQuery);
window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction;window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;var I=window.indexedDB.open("messages",1);I.onerror=function(a){console.error(a)};var E;I.onsuccess=function(a){console.log("Database initialised");E=I.result;"allChat"!=n&&O(n)};I.onupgradeneeded=function(a){a=a.target.result;
a.onerror=function(a){console.error("Error loading database.")};objectStore=a.createObjectStore("messages",{keyPath:"id",autoIncrement:!0});objectStore.createIndex("chat","chat",{unique:!1});objectStore.createIndex("sender","sender",{unique:!1});objectStore.createIndex("message","message",{unique:!1});console.log("Object store created.")};var h=document.getElementById("lines"),C=document.getElementById("contactsSearch"),n=location.search.substring(1)?location.search.substring(1):"allChat",r={};"allChat"!=
n&&(document.getElementsByTagName("span")[0].innerText="\u2630 "+("allChat"===n?"Cool Chat":n));var v=[],z=!1,D=null,w=document.querySelector(".settbtn");"serviceWorker"in navigator&&"PushManager"in window?navigator.serviceWorker.register("/static/service-worker.js").then(function(a){console.log("Service Worker is registered",a);D=a;d()}).catch(function(a){console.error("Service Worker Error",a)}):(console.warn("Push messaging is not supported"),w.textContent="Push Not Supported");document.getElementById("Logout").addEventListener("click",
function(){try{y()}catch(a){}localStorage.clear();location.reload();return!1});var u;$(document).bind("click",function(a){document.getElementById("rmenu").className="hide"});document.addEventListener?document.addEventListener("contextmenu",function(a){console.log(a.target.parentElement);var b=a.target.getAttribute("dbid")?a.target:a.target.parentElement;b=b.getAttribute("dbid")?b:null;console.log(a.target.getAttribute("dbid"));console.log(b||"Didn't click on a message!");if(b&&"lines"===b.parentElement.getAttribute("id")&&
0!==b.getAttribute("dbid")){a.preventDefault();document.getElementById("rmenu").innerHTML='<ul><li>Do you really want to delete the message?</li><li id="messageToDelete"> </li><li> <div><a class="danger" style="cursor: pointer;">Yes</a></div><div><a style="cursor: pointer;">No</a></div></li></ul>';document.getElementById("rmenu").className="show";var f=document.getElementById("rmenu").style;var d=event.pageY?event.pageY:event.clientY?event.clientY+(document.documentElement.scrollTop?document.documentElement.scrollTop:
document.body.scrollTop):null;f.top=d+"px";f=document.getElementById("rmenu").style;d=event.pageX?event.pageX:event.clientX?event.clientX+(document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft):null;f.left=d+"px";document.getElementById("rmenu").onclick=c;b.children[1]&&"IMG"===b.children[1].tagName?document.getElementById("messageToDelete").innerHTML="<b>"+b.children[0].innerHTML+"</b>: Image":document.getElementById("messageToDelete").innerHTML=b.innerHTML;
u=a;u.rootEl=b}},!1):document.attachEvent("oncontextmenu",function(){window.event.returnValue=!1});var m=io.connect();m.on("connect",function(){$("#chat").addClass("connected");null!==localStorage.getItem("name")&&null!==localStorage.getItem("passwd")&&m.emit("nickname",{nick:localStorage.getItem("name"),passwd:localStorage.getItem("passwd")},function(a){if(!a)return x("System","Reconnected to the server with localStorage"),document.getElementById("message").disabled=!1,document.getElementById("imagefile").disabled=
!1,$("#chat").addClass("nickname-set")})});m.on("announcement",function(a){$("#lines").append($("<p>").append($("<em>").text(a)))});m.on("reload",function(){return location.reload()});m.on("nicknames",function(a){v=a;$("#nicknames").empty().append($("<span>Online: </span>"));$("#nicknames").append($("<b>").text("allChat"));for(var b in v)$("#nicknames").append($(v[b]===localStorage.getItem("name")?'<b style="background: coral">':"<b>").text(v[b]))});document.getElementById("nicknames").addEventListener("click",
function(a){a=a.target;if("B"==a.tagName&&a.innerText!==localStorage.getItem("name")){cycleNavBar();n=a.innerText;"allChat"!==n&&m.emit("getKey",n);document.getElementsByTagName("span")[1].innerText="\u2630 "+("allChat"===n?"Cool Chat":n);h.innerHTML="";if(!O(n)&&null!=r[n]){a=$jscomp.makeIterator(r[n]);for(var b=a.next();!b.done;b=a.next())b=b.value,h.innerHTML+="<p><b>"+b.from+"</b>"+b.msg+"</p>"}setTimeout(function(){return h.scrollTop=h.scrollHeight},10)}});m.on("user message",function(a,b){q(a,
b,chat="allChat")});m.on("user image",M);m.on("dm",function(a){return q(a.from,a.msg)});m.on("reconnect",function(){m.emit("nickname",{nick:localStorage.getItem("name"),passwd:localStorage.getItem("passwd")},function(a){if(!a)return $("#message").val("").focus(),document.getElementById("message").disabled=!1,document.getElementById("imagefile").disabled=!1,$("#chat").addClass("nickname-set");y();location.reload()});x("System","Reconnected to the server")});m.on("dmImage",function(a){var b=(h.clientWidth|
0)-20,c=(h.clientHeight|0)-20;a.from==n?b<c?q(a.from,'<img background-image src="'+a.msg+'" width="'+b+'"/>'):q(a.from,'<img background-image src="'+a.msg+'" height="'+c+'"/>'):(t(a.from,a.from,'<img background-image src="'+a.msg+'" width="'+b+'"/>'),r.hasOwnProperty(a.from)||(r[a.from]=[]),r[a.from].push({from:a.from,msg:'<img background-image src="'+a.msg+'" width="'+b+'"/>'}))});m.on("disconnect",function(){return x("System","Disconnected")});m.on("error",function(a){x("System",a?a:"A unknown error occurred")});
C.onchange=C.onkeyup=C.onclick=function(){if(""!=C.value){nicks=fuzzysort.go(C.value,Object.values(v),{threshold:-999});$("#nicknames").empty().append($("<span>Online: </span>"));$("#nicknames").append($("<b>").text("allChat"));for(var a in nicks)$("#nicknames").append($(nicks[a].target===localStorage.getItem("name")?'<b style="background: coral">':"<b>").text(nicks[a].target)),$("#nicknames").append($("<b>").text())}else for(a in $("#nicknames").empty().append($("<span>Online: </span>")),$("#nicknames").append($("<b>").text("allChat")),
v)$("#nicknames").append($(v[a]===localStorage.getItem("name")?'<b style="background: coral">':"<b>").text(v[a]))};$(function(){document.getElementById("register").onclick=function(){localStorage.setItem("name",$("#nick").val());localStorage.setItem("passwd",$("#passwd").val());m.emit("nickname",{nick:$("#nick").val(),passwd:$("#passwd").val()},function(a){if(!a)return $("#message").val("").focus(),document.getElementById("message").disabled=!1,document.getElementById("imagefile").disabled=!1,$("#chat").addClass("nickname-set");
$("#nickname-err").css("visibility","visible")});return!1};$("#send-message").submit(function(a){a.preventDefault();if(n)return A[n]?ba(A[n].encrypt,$("#message").val()).then(function(a){window.crypto.subtle.sign(H,J,a).then(function(b){q("me",$("#message").val(),!0);console.log("sending Encrypted MSG");m.emit("encryptedDM",{user:n,msg:a,signature:b});$("#message").val("").focus();$("#lines").get(0).scrollTop=h.scrollHeight})}):(q("me",$("#message").val()),m.emit("dm",{user:n,msg:$("#message").val()}),
$("#message").val("").focus(),$("#lines").get(0).scrollTop=h.scrollHeight),!1;alert("No dm");x("me",$("#message").val());m.emit("user message",$("#message").val());$("#message").val("").focus();$("#lines").get(0).scrollTop=h.scrollHeight;return!1});$("#imagefile").bind("change",function(a){P(this.files[0],600,Infinity,.9,function(a){M("me",a);m.emit("dmImage",{user:n,msg:a})})});$("#message").pasteImageReader(function(a){a=function(a,b,c){b=void 0===b?"":b;c=void 0===c?512:c;a=atob(a);for(var e=[],
d=0;d<a.length;d+=c){for(var f=a.slice(d,d+c),g=Array(f.length),h=0;h<f.length;h++)g[h]=f.charCodeAt(h);f=new Uint8Array(g);e.push(f)}return new Blob(e,{type:b})}(a.dataURL.slice(22),a.dataURL.slice(5,a.dataURL.indexOf(";")));P(a,600,Infinity,.9,function(a,b){M("me",a);m.emit("dmImage",{user:n,msg:a})})})});HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(a,b,c){c=atob(this.toDataURL(b,c).split(",")[1]);for(var e=c.length,d=new Uint8Array(e),
f=0;f<e;f++)d[f]=c.charCodeAt(f);a(new Blob([d],{type:b||"image/png"}))}});window.URL=window.URL||window.webkitURL;var H={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"},modulusLength:2048,extractable:!1,publicExponent:new Uint8Array([1,0,1])},G={name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),extractable:!1,hash:{name:"SHA-256"}},B=["encrypt","decrypt"],K=!1,J=!1;null!=localStorage.getItem("signKeyS")&&null!=localStorage.getItem("encryptKeyS")&&Z(localStorage.getItem("signKeyS")).then(function(a){aa(localStorage.getItem("encryptKeyS")).then(function(b){J=
a;K=b;console.log("successfully imported Private Keys")})});if(null==localStorage.getItem("encryptKeyP")||null==localStorage.getItem("encryptKeyS"))Q(G,B).then(function(a){K=a.privateKey;U(a).then(function(a){localStorage.setItem("encryptKeyP",a);console.log("PushEncryptKey"+a);m.emit("PushEncryptKey",a)});V(a).then(function(a){localStorage.setItem("encryptKeyS",a)})}).catch(function(a){return console.log(a.message)});else{var N=localStorage.getItem("encryptKeyP");S(N).then(function(a){K=a});console.log("PushEncryptKey"+
N);m.emit("PushEncryptKey",N)}null==localStorage.getItem("signKeyP")||null==localStorage.getItem("signKeyS")?Q(G,B).then(function(a){J=a.privateKey;U(a).then(function(a){localStorage.setItem("signKeyP",a);console.log("PushEncryptKey"+a);m.emit("PushEncryptKey",a)});V(a).then(function(a){localStorage.setItem("signKeyS",a)})}).catch(function(a){return console.log(a.message)}):(B=localStorage.getItem("signKeyP"),T(B).then(function(a){J=a}),console.log("PushSignKey"+B),m.emit("PushSignKey",B));var A=
{};m.on("establishEncryption",function(a,b){console.log("received Key from "+a+":");console.log(b);T(b.sign).then(function(c){S(b.encrypt).then(function(b){A[a]={encrypt:b,sign:c};console.log(c);console.log(b)})})});m.on("encryptedDM",function(a){A[a.from]&&crypto.subtle.decrypt({name:"RSA-OAEP"},K,a.msg).then(function(b){b=Y(b);crypto.subtle.verify(H,A[a.from].sign,a.signature,a.msg).then(function(c){if(!c)return console.log("public Key:"),console.log(A[a.from].sign),console.log("signature:"),console.log(a.signature),
console.log("message"),console.log(a.msg),console.log("decrypted msg"),console.log(b),alert(a.from+" send an invalid message!!!");a.from==n?q(a.from,b,!0):(t(a.from,a.from,b,!0),r.hasOwnProperty(a.from)||(r[a.from]=[]),r[a.from].push({from:a.from,msg:b}));console.log("Signature verified after importing PEM public key:",c)})})})};